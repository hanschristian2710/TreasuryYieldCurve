@page "/treasury-yield-table"
@using Microsoft.AspNetCore.Mvc
@using ModernFI.Models
@using ModernFI.Services
@using System.Net.Http.Headers
@using System.IO.Compression
@using static ModernFI.Services.TreasuryDataService

@rendermode InteractiveServer

@inject ITreasuryDataService FiscalService

<PageTitle>Treasury Rate Data</PageTitle>

<h3>Treasury Yield Data</h3>
<small class="fst-italic">Max 90 days range</small>
<div class="row mb-3">
    <div class="col">
        <label class="form-label">From</label>
        <input type="date" class="form-control" @bind="From" />
    </div>
    <div class="col">
        <label class="form-label">To</label>
        <input type="date" class="form-control" @bind="To" />
    </div>
    <div class="col-auto d-flex align-items-end">
        <button class="btn btn-primary" @onclick="ApplyCustomRange">
            Apply
        </button>
    </div>
</div>

@if (IsLoading)
{
    <p>Loading Treasury Data...</p>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}
else
{
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Month 1</th>
                <th>Month 2</th>
                <th>Month 3</th>
                <th>Month 6</th>
                <th>Year 1</th>
                <th>Year 2</th>
                <th>Year 3</th>
                <th>Year 5</th>
                <th>Year 7</th>
                <th>Year 10</th>
                <th>Year 20</th>
                <th>Year 30</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var item in PagedData)
            {
                <tr>
                    <td>@item.date</td>
                    <td>@item.month1</td>
                    <td>@item.month2</td>
                    <td>@item.month3</td>
                    <td>@item.month6</td>
                    <td>@item.year1</td>
                    <td>@item.year2</td>
                    <td>@item.year3</td>
                    <td>@item.year5</td>
                    <td>@item.year7</td>
                    <td>@item.year10</td>
                    <td>@item.year20</td>
                    <td>@item.year30</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center mt-2 mb-3">
        <!-- Rows per page -->
        <div class="d-flex align-items-center">
            <label class="me-2 mb-0">Rows per page:</label>
            <select class="form-select form-select-sm w-auto" @onchange="PageSizeChanged">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
        <div>
            Page @CurrentPage of @TotalPages
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary me-2" @onclick="PreviousPage" disabled="@(CurrentPage == 1)">Previous</button>
            <button class="btn btn-sm btn-outline-primary" @onclick="NextPage" disabled="@(CurrentPage == TotalPages)">Next</button>
        </div>
    </div>

}

@code {

    private List<TreasuryYield>? Response;
    private bool IsLoading = false;
    private string? ErrorMessage;
    private DateTime? From;
    private DateTime? To;

    #region pages related variables

    private int CurrentPage = 1;
    private int PageSize = 10;
    private int TotalPages => (int)Math.Ceiling((Response?.Count ?? 0) / (double)PageSize);
    private IEnumerable<TreasuryYield> PagedData =>
        Response?.Skip((CurrentPage - 1) * PageSize).Take(PageSize) ?? Enumerable.Empty<TreasuryYield>();

    #endregion

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    /// <summary>
    /// Apply custom date range
    /// </summary>
    /// <returns></returns>
    private async Task ApplyCustomRange()
    {
        if (From != null && To != null)
        {
            var diff = (To.Value.Date - From.Value.Date).TotalDays;
            if (diff > 90)
            {
                ErrorMessage = "Date range cannot exceed 90 days.";
                return;
            }
        }

        CurrentPage = 1;

        await LoadData();
    }

    /// <summary>
    /// Get date range filter based on users's selection
    /// API Limitation: max 90 days date range
    /// </summary>
    /// <returns></returns>
    private (DateTime? start, DateTime? end) GetDateRangeFilter()
    {
        if (From is null && To is not null)
            From = To.Value.Date.AddDays(-90);
        if (From is not null && To is null)
            To = From.Value.Date.AddDays(90);

        if (From is null && To is null)
        {
            To = DateTime.Now;
            From = To.Value.Date.AddDays(-90);
        }
        
        return (From, To);
    }

    /// <summary>
    /// Function to request data
    /// </summary>
    /// <returns></returns>
    private async Task LoadData()
    {
        ErrorMessage = null;
        IsLoading = true;

        try
        {
            var (start, end) = GetDateRangeFilter();

            Response = await FiscalService.GetTreasuryRates(start, end);
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }

        IsLoading = false;
    }

    #region Pages handler

    private void PageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var newSize))
        {
            PageSize = newSize;
            CurrentPage = 1;
        }
    }

    private void PreviousPage()
    {
        if (CurrentPage > 1) CurrentPage--;
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages) CurrentPage++;
    }

    #endregion
}