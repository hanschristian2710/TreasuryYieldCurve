@page "/treasury-yield-table"
@using ModernFI.Models
@using ModernFI.Services
@using System.Net.Http.Headers

@rendermode InteractiveServer

@inject IFiscalDataService FiscalService

<PageTitle>Treasury Yield Data Table</PageTitle>

<h3>Treasury Yields</h3>

<div class="mb-3">
    <label class="form-label"><strong>Date Range</strong></label>
    <select class="form-select" @onchange="OnDateRangeChanged">
        <option value="LatestMonth">Latest Month</option>
        <option value="OneYear">1 Year</option>
        <option value="FiveYears">5 Years</option>
        <option value="All">All</option>
        <option value="Custom">Custom</option>
    </select>
</div>

@if (SelectedRange == "Custom")
{
    <div class="row mb-3">
        <div class="col">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" @bind="CustomStart" />
        </div>
        <div class="col">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" @bind="CustomEnd" />
        </div>
        <div class="col-auto d-flex align-items-end">
            <button class="btn btn-primary" @onclick="ApplyCustomRange">
                Apply
            </button>
        </div>
    </div>
}

@if (IsLoading)
{
    <p>Loading Fiscal Data...</p>
}
else if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}
else
{
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Security Type</th>
                <th>Description</th>
                <th>Interest Rate (%)</th>
            </tr>
        </thead>

        <tbody>
            @if (Response?.data != null)
            {
                @foreach (var item in Response.data)
                {
                    <tr>
                        <td>@item.RecordDate?.ToString("yyyy-MM-dd")</td>
                        <td>@item.SecurityTypeDesc</td>
                        <td>@item.SecurityDesc</td>
                        <td>@item.AvgInterestRateAmt</td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <div class="d-flex align-items-center mt-3">
        <!-- Pagination buttons -->
        <div class="me-3">
            <button class="btn btn-secondary me-2" disabled="@(!HasPage(Page.First))" @onclick="() => LoadPage(Page.First)">First</button>
            <button class="btn btn-secondary me-2" disabled="@(!HasPage(Page.Prev))" @onclick="() => LoadPage(Page.Prev)">Prev</button>
            <button class="btn btn-secondary me-2" disabled="@(!HasPage(Page.Next))" @onclick="() => LoadPage(Page.Next)">Next</button>
            <button class="btn btn-secondary" disabled="@(!HasPage(Page.Last))" @onclick="() => LoadPage(Page.Last)">Last</button>
        </div>

        <!-- Rows per page selector -->
        <div class="ms-auto d-flex align-items-center">
            <label class="me-2 mb-0"><strong>Rows per page:</strong></label>
            <select class="form-select" style="width: auto;" @onchange="OnPageRowsChanged">
                <option value="10" selected="@((TotalRowsPerPage == 10))">10</option>
                <option value="25" selected="@((TotalRowsPerPage == 25))">25</option>
                <option value="50" selected="@((TotalRowsPerPage == 50))">50</option>
                <option value="100" selected="@((TotalRowsPerPage == 100))">100</option>
            </select>
        </div>

    </div>


    <p class="mt-2">
        Showing page: <strong>@CurrentPage</strong> of <strong>@TotalPages</strong>
    </p>
}

@code {

    private TreasuryYieldAPIResponse? Response;
    private bool IsLoading = false;
    private string? ErrorMessage;
    private string SelectedRange = "LatestMonth";
    private DateTime? CustomStart;
    private DateTime? CustomEnd;
    private int CurrentPage = 1;
    private int TotalRowsPerPage = 50;
    private int TotalPages = 1;

    private enum Page {
        First,
        Prev,
        Next,
        Last
    }

    /// <summary>
    /// Point of entry
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    /// <summary>
    /// Triggered when range changes
    /// </summary>
    /// <param name="e"></param>
    /// <returns></returns>
    private async Task OnDateRangeChanged(ChangeEventArgs e) {
        SelectedRange = e.Value?.ToString() ?? "LatestMonth";

        // Reload the data with the selected range properties
        if (SelectedRange == "Custom")
            return;

        CurrentPage = 1;
        await LoadData();
    }

    /// <summary>
    /// Apply custom date range
    /// </summary>
    /// <returns></returns>
    private async Task ApplyCustomRange()
    {
        // Both start and end is required
        if (CustomStart == null || CustomEnd == null)
        {
            ErrorMessage = "Custom start and end dates are required.";
            return;
        }

        CurrentPage = 1;
        await LoadData();
    }

    /// <summary>
    /// Get date range filter based on users's selection
    /// </summary>
    /// <returns></returns>
    private (DateTime? start, DateTime? end) GetDateRangeFilter()
    {
        var today = DateTime.Today;
        // Latest data is up to prev month data
        var latestFiscalStart = new DateTime(today.Year, today.Month - 1, 1);
        var latestFiscalEnd = latestFiscalStart.AddMonths(1).AddDays(-1);

        switch (SelectedRange) {
            case "LatestMonth":
                return (latestFiscalStart, latestFiscalEnd);
            case "OneYear":
                return (today.AddYears(-1), latestFiscalEnd);
            case "FiveYears":
                return (today.AddYears(-5), latestFiscalEnd);
            case "All":
                return (null, null);
            case "Custom":
                return (CustomStart, CustomEnd);
            default:
                return (null, null);
        }
    }

    /// <summary>
    /// Function to request data
    /// </summary>
    /// <returns></returns>
    private async Task LoadData()
    {
        ErrorMessage = null;
        IsLoading = true;

        try
        {
            CurrentPage = 1;

            var (start, end) = GetDateRangeFilter();

            Response = await FiscalService.GetAverageInterestRate(start, end, TotalRowsPerPage);

            UpdatePageInfo();
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }

        IsLoading = false;
    }

    #region Pages Handler

    private bool HasPage(Page option) {
        switch (option)
        {
            case Page.First:
                return Response?.links?.first != null;
            case Page.Prev:
                return Response?.links?.prev  != null;
            case Page.Next:
                return Response?.links?.next  != null;
            case Page.Last:
                return Response?.links?.last  != null;
            default:
                return false;
        }
    }

    private string GetPageLink(Page option) {
        switch (option)
        {
            case Page.First:
                return Response!.links!.first!;
            case Page.Prev:
                return Response!.links!.prev!;
            case Page.Next:
                return Response!.links!.next!;
            case Page.Last:
                return Response!.links!.last!;
            default:
                return string.Empty;
        }
    }

    private async Task OnPageRowsChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            if (TotalRowsPerPage != newSize) {
                TotalRowsPerPage = newSize;
                CurrentPage = 1;

                // Reload the table
                await LoadData();
            }
        }
    }

    private async Task LoadPage(Page option)
    {
        ErrorMessage = null;
        IsLoading = true;

        try
        {
            var (start, end) = GetDateRangeFilter();
            Response = await FiscalService.GetAverageInterestRateByContinuationLink(GetPageLink(option), start, end);
            UpdatePageInfo();
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }

        IsLoading = false;
    }

    #endregion

    private void UpdatePageInfo()
    {
        CurrentPage = ExtractCurrentPageNumber(Response?.links?.self);
        TotalPages = Response?.meta?.totalPages ?? 1;
    }

    private int ExtractCurrentPageNumber(string? link)
    {
        if (string.IsNullOrEmpty(link)) return 1;

        // Extract number from: page%5Bnumber%5D=3
        var param = System.Web.HttpUtility.ParseQueryString(link);
        var page = param.Get("page[number]");

        return int.TryParse(page, out int result) ? result : 1;
    }
}
